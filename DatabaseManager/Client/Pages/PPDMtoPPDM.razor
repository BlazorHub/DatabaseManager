@page "/ppdmtoppdm"
@inject IDatabaseTransfer databaseTransfer
@inject SingletonServices singleton

<h2>PPDM to PPDM Data Transfer</h2>

<TransferParametersForm TransferParameters="transferParameters" OnValidSubmit="StartDatabaseTransfer" />

<div>
    <p>Current status: @statusMessage</p>
</div>


@code {
    private string statusMessage = "Not started";
    private string jsonString = "";
    TransferParameters transferParameters = new TransferParameters();

    protected async Task StartDatabaseTransfer()
    {
        Console.WriteLine("Start database transfer");
        foreach (string tableName in DatabaseTables.Names)
        {
            transferParameters.Table = tableName;
            transferParameters.TargetName = singleton.TargetConnector;
            progress($"Deleting from {tableName}"); 
            try
            {
                await databaseTransfer.Delete(transferParameters);
            }
            catch (Exception ex)
            {
                progress($"Error Deleting from {tableName}: {ex.Message}");
                return;
            }
        }

        foreach (string tableName in CopyTables.Names)
        {
            transferParameters.Table = tableName;
            progress($"Copying table {tableName}");
            try
            {
                await databaseTransfer.Copy(transferParameters);
            }
            catch (Exception ex)
            {
                progress($"Error copying from {tableName}: {ex.Message}");
                return;
            }
        }

        progress($"Transfer Complete");
    }

    private void progress(string message)
    {
        statusMessage = message;
        StateHasChanged();
    }
}
